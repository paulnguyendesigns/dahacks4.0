<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Season Color Finder</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #020617;
        color: #e5e7eb;
        padding: 20px;
      }
      .card {
        max-width: 600px;
        margin: 0 auto;
        background: #020617;
        border: 1px solid #1f2937;
        border-radius: 16px;
        padding: 16px;
      }
      .swatch {
        border-radius: 10px;
        border: 1px solid #1f2937;
        overflow: hidden;
        width: 90px;
        margin: 4px;
        font-size: 11px;
      }
      .swatch-color {
        height: 30px;
      }
      .swatch-info {
        padding: 4px;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Season Color Finder</h1>
      <p>Upload a clear selfie. We'll guess your color season and palette.</p>

      <input type="file" id="fileInput" accept="image/*" />
      <button id="analyzeBtn">Analyze</button>

      <p id="status" style="font-size: 12px; color: #9ca3af"></p>

      <div id="result" style="margin-top: 16px"></div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");

    analyzeBtn.addEventListener("click", async () => {
        const file = fileInput.files[0];
        if (!file) {
         statusEl.textContent = "Please choose a photo first.";
         return;
         }

        statusEl.textContent = "Uploading and analyzing...";
        resultEl.innerHTML = "";

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch("/analyze", {
            method: "POST",
            body: formData,
            });

            const text = await res.text();   // read raw text FIRST
            let data;

            try {
            data = JSON.parse(text);
            } catch (e) {
            // server didn't send JSON â€“ show raw text
            throw new Error(
                "Server did not return JSON. Raw response:\n" + text
            );
            }

            if (!res.ok) {
            throw new Error(data.error || `Server error (${res.status})`);
            }

            const analysis = data.analysis;
            statusEl.textContent = "";
            renderResult(analysis);
        } catch (err) {
            console.error(err);
            statusEl.textContent = "Error: " + err.message;
            }
    });

      function renderResult(a) {
        resultEl.innerHTML = "";

        const header = document.createElement("div");
        header.innerHTML = `
          <h2>${a.season}</h2>
          <p style="font-size: 12px; color:#9ca3af">
            Confidence: ${(a.confidence * 100).toFixed(0)}%
          </p>
          <p style="font-size: 12px;">
            Skin: <span style="font-family:monospace">${a.base_skin_hex}</span> |
            Hair: <span style="font-family:monospace">${a.hair_hex}</span> |
            Eyes: <span style="font-family:monospace">${a.eye_hex}</span>
          </p>
        `;
        resultEl.appendChild(header);

        const row = document.createElement("div");
        row.className = "row";
        a.palette.forEach((c) => {
          const box = document.createElement("div");
          box.className = "swatch";
          box.innerHTML = `
            <div class="swatch-color" style="background:${c.hex}"></div>
            <div class="swatch-info">
              <div>${c.name}</div>
              <div style="font-family:monospace">${c.hex}</div>
            </div>
          `;
          row.appendChild(box);
        });
        resultEl.appendChild(row);

        if (a.notes && a.notes.length) {
          const notes = document.createElement("ul");
          notes.style.fontSize = "12px";
          a.notes.forEach((n) => {
            const li = document.createElement("li");
            li.textContent = n;
            notes.appendChild(li);
          });
          resultEl.appendChild(notes);
        }
      }
    </script>
  </body>
</html>
